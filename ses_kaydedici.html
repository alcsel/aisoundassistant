<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ses Kaydedici</title>
</head>
<body>
    <div style="text-align: center; margin-top: 50px;">
        <button id="recordButton" style="font-size: 20px; padding: 10px 20px;">üé§ Kayda Ba≈üla</button>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];

        const recordButton = document.getElementById('recordButton');

        recordButton.addEventListener('click', async () => {
            try {
                if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                    // Mikrofon eri≈üimini kontrol et
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        if (audioChunks.length === 0) {
                            alert('Ses kaydedilemedi. Mikrofonun √ßalƒ±≈ütƒ±ƒüƒ±ndan emin olun.');
                            return;
                        }

                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(audioBlob);

                        // Ses dosyasƒ±nƒ± metne √ßevirme i≈ülemi
                        const formData = new FormData();
                        formData.append('audio', audioBlob, 'kayit.webm');

                        try {
                            const response = await fetch('http://localhost:5000/convert', {
                                method: 'POST',
                                body: formData
                            });

                            if (!response.ok) {
                                throw new Error('Metne √ßevirme i≈ülemi ba≈üarƒ±sƒ±z oldu.');
                            }

                            const text = await response.text();

                            // Metni indir
                            const textBlob = new Blob([text], { type: 'text/plain' });
                            const textUrl = URL.createObjectURL(textBlob);
                            const a = document.createElement('a');
                            a.href = textUrl;
                            a.download = 'kayit_metni.txt';
                            a.click();

                            // Metni sesli olarak oynat
                            // const utterance = new SpeechSynthesisUtterance(text);
                            // window.speechSynthesis.speak(utterance);
                        } catch (error) {
                            alert('Metne √ßevirme sƒ±rasƒ±nda bir hata olu≈ütu: ' + error.message);
                        }

                        audioChunks = [];
                    };

                    mediaRecorder.start();
                    recordButton.textContent = '‚èπ Kaydƒ± Durdur';
                } else if (mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    recordButton.textContent = 'üé§ Kayda Ba≈üla';
                }
            } catch (error) {
                alert('Mikrofon eri≈üimi reddedildi veya bir hata olu≈ütu: ' + error.message);
            }
        });
    </script>
</body>
</html>